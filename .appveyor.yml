---
version: "{build}-{branch}"

before_build:
  - curl -fsSL https://gist.github.com/cfillion/da355e8278048de08ae065d6fe6031c1/raw/reaper_plugin_functions.h -o vendor/reaper_plugin_functions.h
  - git submodule update --init

for:
  - matrix: { only: [ APPVEYOR_BUILD_WORKER_IMAGE: &linux Ubuntu1804 ] }
    install:
      - sudo apt-get update -qq
      - sudo apt-get install -qq --no-install-recommends php

      - |-
        case $ARCH in
        i686)
          sudo apt-get install -qq g++-multilib &&
          export TOOLCHAIN=../cmake/linux-cross.cmake \
                 TOOLCHAIN_PREFIX=i386-linux-gnu
          ;;
        armv7l)
          sudo apt-get install -qq g++-arm-linux-gnueabihf &&
          export TOOLCHAIN=../cmake/linux-cross.cmake \
                 TOOLCHAIN_PREFIX=arm-linux-gnueabihf
          ;;
        aarch64)
          sudo apt-get install -qq g++-aarch64-linux-gnu &&
          export TOOLCHAIN=../cmake/linux-cross.cmake \
                 TOOLCHAIN_PREFIX=aarch64-linux-gnu
          ;;
        esac
    build_script:
      - mkdir build && cd build
      - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN
      - cmake --build .
      - cpack
    artifacts:
      - path: build/sws*.tar.xz

  - matrix: { only: [ APPVEYOR_BUILD_WORKER_IMAGE: &windows Visual Studio 2019 ] }
    install:
      - choco install -y nsis php
      - refreshenv
      - curl -fsSLO https://nsis.sourceforge.io/mediawiki/images/1/18/NsProcess.zip
      - 7z e nsProcess.zip -o"%ProgramFiles(x86)%\NSIS\Plugins\x86-unicode" nsProcessW.dll -r
      - if "%ARCH%" == "x64" call "%ProgramFiles(x86)%\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
      - if "%ARCH%" == "x86" call "%ProgramFiles(x86)%\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars32.bat"
    build_script:
      - mkdir build && cd build
      - cmake .. -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - cmake --build . --target all langpack
      - cpack
    artifacts:
      - path: build\sws*.exe
      - path: build\reaper_sws*.pdb
      - path: build\BuildUtils\SWS_Template.ReaperLangPack

environment:
  matrix:
    - { APPVEYOR_BUILD_WORKER_IMAGE: *windows, ARCH: x64     }
    - { APPVEYOR_BUILD_WORKER_IMAGE: *windows, ARCH: x86     }
    - { APPVEYOR_BUILD_WORKER_IMAGE: *linux,   ARCH: x86_64  }
    - { APPVEYOR_BUILD_WORKER_IMAGE: *linux,   ARCH: i686    }
    - { APPVEYOR_BUILD_WORKER_IMAGE: *linux,   ARCH: armv7l  }
    - { APPVEYOR_BUILD_WORKER_IMAGE: *linux,   ARCH: aarch64 }

notifications:
  - provider: GitHubPullRequest
    template: |-
      {{#passed}}:white_check_mark:{{/passed}}{{#failed}}:x:{{/failed}} [Build {{&projectName}} {{buildVersion}} {{status}}]({{buildUrl}}) (commit {{commitUrl}} by @{{&commitAuthorUsername}})
      {{#passed}}{{#jobs}}

      <details>
      <summary>{{name}}</summary>

      {{#artifacts}}
      - [{{fileName}}]({{permalink}})
      {{/artifacts}}
      </details>
      {{/jobs}}{{/passed}}
